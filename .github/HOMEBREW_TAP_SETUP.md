# Homebrew Tap Setup Guide

This document explains how the xcargo Homebrew tap is configured and what's required for automatic formula publishing.

## Overview

xcargo uses [cargo-dist](https://opensource.axo.dev/cargo-dist/) to automatically publish Homebrew formulae to a custom tap on each release. This allows users to install xcargo via:

```bash
brew install ibrahimcesar/tap/xcargo
```

## Repository Setup

### 1. Create the Homebrew Tap Repository

The tap repository must follow Homebrew's naming convention:

```bash
# Repository name MUST be: homebrew-<tap-name>
https://github.com/ibrahimcesar/homebrew-tap
```

**Structure:**
```
homebrew-tap/
├── Formula/
│   └── xcargo.rb          # Auto-generated by cargo-dist
└── README.md              # Optional: tap description
```

### 2. Configure GitHub Token

cargo-dist requires a GitHub token with permissions to push to the tap repository.

**Create a Personal Access Token:**

1. Go to GitHub Settings → Developer settings → Personal access tokens → Fine-grained tokens
2. Click "Generate new token"
3. Configure:
   - **Token name:** `xcargo-homebrew-tap`
   - **Expiration:** 1 year (or custom)
   - **Repository access:** Only select repositories
     - Select: `ibrahimcesar/homebrew-tap`
   - **Permissions:**
     - Contents: Read and write
     - Metadata: Read-only

4. Generate token and copy it

**Add Token to xcargo Repository:**

1. Go to `ibrahimcesar/xcargo` → Settings → Secrets and variables → Actions
2. Click "New repository secret"
3. Name: `HOMEBREW_TAP_TOKEN`
4. Value: Paste the token
5. Click "Add secret"

### 3. cargo-dist Configuration

Already configured in [Cargo.toml](../../Cargo.toml:134-136):

```toml
[workspace.metadata.dist]
# ...existing config...
tap = "ibrahimcesar/homebrew-tap"
publish-jobs = ["homebrew"]
```

## How It Works

### Release Workflow

When a new release is created:

1. **Build Phase** ([.github/workflows/release.yml](../workflows/release.yml))
   - Builds binaries for all targets
   - Generates `xcargo.rb` Homebrew formula
   - Uploads formula as artifact

2. **Publish Phase** (`publish-homebrew-formula` job)
   - Checks out `ibrahimcesar/homebrew-tap` using `HOMEBREW_TAP_TOKEN`
   - Downloads the generated formula
   - Runs `brew style --fix` to ensure formula passes Homebrew linting
   - Commits formula to `Formula/xcargo.rb`
   - Pushes to tap repository

3. **Users Install**
   ```bash
   # Add tap (first time only)
   brew tap ibrahimcesar/tap

   # Install xcargo
   brew install xcargo

   # Or in one command
   brew install ibrahimcesar/tap/xcargo
   ```

### Formula Auto-Generation

cargo-dist generates the formula with:
- Download URLs for all macOS and Linux binaries
- SHA256 checksums
- Dependencies (none for xcargo currently)
- Installation instructions
- Caveats (if configured)

**Example generated formula:**
```ruby
class Xcargo < Formula
  desc "Cross-compilation, zero friction - Rust cross-compilation tool"
  homepage "https://ibrahimcesar.github.io/xcargo"
  version "0.3.0"

  on_macos do
    if Hardware::CPU.arm?
      url "https://github.com/ibrahimcesar/xcargo/releases/download/v0.3.0/xcargo-aarch64-apple-darwin.tar.xz"
      sha256 "..."
    else
      url "https://github.com/ibrahimcesar/xcargo/releases/download/v0.3.0/xcargo-x86_64-apple-darwin.tar.xz"
      sha256 "..."
    end
  end

  on_linux do
    url "https://github.com/ibrahimcesar/xcargo/releases/download/v0.3.0/xcargo-x86_64-unknown-linux-gnu.tar.xz"
    sha256 "..."
  end

  def install
    bin.install "xcargo"
  end
end
```

## Verification

### Test the Tap Locally

After a release is published:

```bash
# Add the tap
brew tap ibrahimcesar/tap

# Check formula info
brew info ibrahimcesar/tap/xcargo

# Install
brew install ibrahimcesar/tap/xcargo

# Verify installation
xcargo --version
```

### Troubleshooting

**Formula not found:**
- Check that `homebrew-tap` repository exists and is public
- Verify formula was committed to `Formula/xcargo.rb`
- Run `brew update` to refresh tap

**Installation fails:**
- Check SHA256 checksums match release artifacts
- Verify download URLs are accessible
- Check Homebrew logs: `brew install --verbose --debug ibrahimcesar/tap/xcargo`

**Token issues:**
- Verify `HOMEBREW_TAP_TOKEN` is set in xcargo repository secrets
- Check token has not expired
- Ensure token has write permissions to homebrew-tap repo

## Security Notes

- **Token Scope:** Token only has access to `homebrew-tap`, not `xcargo` repository
- **Token Storage:** Stored as encrypted GitHub secret, only accessible to release workflow
- **Formula Security:** All binaries use SHA256 checksums for integrity verification
- **Homebrew Audit:** Formula passes `brew audit` and `brew style` checks

## Updates and Maintenance

### Updating the Formula

cargo-dist automatically updates the formula on every release. No manual intervention needed.

### Deprecating Versions

To remove old versions from the tap:

```bash
cd homebrew-tap
git rm Formula/xcargo@0.2.0.rb  # If versioned formula exists
git commit -m "Remove xcargo 0.2.0"
git push
```

### Tap Analytics

Homebrew tracks installation analytics (opt-in for users):

```bash
# View tap analytics (if enabled)
brew analytics tap-installations ibrahimcesar/tap
```

## Alternative: Core Homebrew

Once xcargo is mature and widely used, consider submitting to homebrew-core:

1. Formula must be stable (v1.0.0+)
2. 75+ stars on GitHub
3. 30+ forks or notable usage
4. No dependencies on non-core formulae

See: https://docs.brew.sh/Acceptable-Formulae

## References

- [cargo-dist Homebrew documentation](https://opensource.axo.dev/cargo-dist/book/installers/homebrew.html)
- [Homebrew Formula Cookbook](https://docs.brew.sh/Formula-Cookbook)
- [Homebrew Acceptable Formulae](https://docs.brew.sh/Acceptable-Formulae)
- [GitHub Fine-grained Tokens](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#creating-a-fine-grained-personal-access-token)
