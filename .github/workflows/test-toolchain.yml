name: Test Bundled Toolchains

on:
  workflow_dispatch: # Manual trigger
  push:
    paths:
      - 'scripts/test_manual_cross_compilation.sh'
      - '.github/workflows/test-toolchain.yml'
      - 'docs/BUNDLED_TOOLCHAINS.md'

env:
  CARGO_TERM_COLOR: always

jobs:
  test-linux-toolchain:
    name: Test Bootlin Toolchain on Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Run toolchain test
        run: |
          chmod +x scripts/test_manual_cross_compilation.sh
          scripts/test_manual_cross_compilation.sh

      - name: Display test results
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d ".toolchain_test" ]; then
            echo "### Toolchain Size Analysis" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cd .toolchain_test
            echo "| Component | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|------|" >> $GITHUB_STEP_SUMMARY

            if [ -f "x86-64--glibc--stable-2025.08-1.tar.xz" ]; then
              SIZE=$(du -h x86-64--glibc--stable-2025.08-1.tar.xz | cut -f1)
              echo "| Original tarball | $SIZE |" >> $GITHUB_STEP_SUMMARY
            fi

            if [ -d "x86-64--glibc--stable-2025.08-1" ]; then
              SIZE=$(du -sh x86-64--glibc--stable-2025.08-1 | cut -f1)
              echo "| Extracted toolchain | $SIZE |" >> $GITHUB_STEP_SUMMARY
            fi

            if [ -d "xcargo-toolchain-x86_64-linux-gnu" ]; then
              SIZE=$(du -sh xcargo-toolchain-x86_64-linux-gnu | cut -f1)
              echo "| Minimal repackage | $SIZE |" >> $GITHUB_STEP_SUMMARY
            fi

            if [ -f "xcargo-toolchain-x86_64-linux-gnu.tar.gz" ]; then
              SIZE=$(du -h xcargo-toolchain-x86_64-linux-gnu.tar.gz | cut -f1)
              echo "| Minimal tarball | $SIZE |" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY

            # Check if test binary was created
            if [ -f "test-hello/target/x86_64-unknown-linux-gnu/release/test-hello" ]; then
              echo "### ✅ Cross-compilation successful!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Binary info:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              file test-hello/target/x86_64-unknown-linux-gnu/release/test-hello >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "### ❌ Cross-compilation failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Test directory not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload minimal toolchain artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: xcargo-minimal-toolchain-x86_64-linux-gnu
          path: .toolchain_test/xcargo-toolchain-x86_64-linux-gnu.tar.gz
          retention-days: 7

      - name: Upload test binary
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: test-binary-x86_64-linux-gnu
          path: .toolchain_test/test-hello/target/x86_64-unknown-linux-gnu/release/test-hello
          retention-days: 7

  test-macos-detection:
    name: Test Platform Detection on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test platform detection (should warn and prompt)
        run: |
          chmod +x scripts/test_manual_cross_compilation.sh
          # Send 'n' to the prompt to exit gracefully
          echo "n" | scripts/test_manual_cross_compilation.sh || true

      - name: Verify warning displayed
        run: |
          echo "## macOS Platform Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Script correctly detects non-Linux platform" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Platform: macOS" >> $GITHUB_STEP_SUMMARY
          echo "Expected behavior: Warning displayed, test cancelled" >> $GITHUB_STEP_SUMMARY

  test-windows-detection:
    name: Test Platform Detection on Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test platform detection (should warn and prompt)
        shell: bash
        run: |
          chmod +x scripts/test_manual_cross_compilation.sh
          # Send 'n' to the prompt to exit gracefully
          echo "n" | scripts/test_manual_cross_compilation.sh || true

      - name: Verify warning displayed
        shell: bash
        run: |
          echo "## Windows Platform Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Script correctly detects non-Linux platform" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Platform: Windows (MINGW/MSYS)" >> $GITHUB_STEP_SUMMARY
          echo "Expected behavior: Warning displayed, test cancelled" >> $GITHUB_STEP_SUMMARY
